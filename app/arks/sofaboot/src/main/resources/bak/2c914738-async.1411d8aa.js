(("undefined"!=typeof globalThis?globalThis:self)["makoChunk_open-semantic-graph"]=("undefined"!=typeof globalThis?globalThis:self)["makoChunk_open-semantic-graph"]||[]).push([["2c914738"],{"2c914738":function(e,t,i){"use strict";i.d(t,"__esModule",{value:!0}),i.e(t,{DefaultModelSHA1Computer:function(){return I;},ModelService:function(){return b;}});var o,s=i("852bbaa9"),n=i("e793196d"),r=i("77b755a9"),a=s._(i("c83e5ca5")),d=i("c6a657e2"),l=i("e7f83d1e"),c=i("cff8cc1d"),u=i("eaa7c5e8"),h=i("5bb4e77a"),p=i("25229b8a"),_=i("96875aa5"),S=i("77171b57"),g=i("b1fc2372"),m=i("aca47fe0"),f=i("2aa5bed3"),M=this&&this.__decorate||function(e,t,i,o){var s,n=arguments.length,r=n<3?t:null===o?o=Object.getOwnPropertyDescriptor(t,i):o;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)r=Reflect.decorate(e,t,i,o);else for(var a=e.length-1;a>=0;a--)(s=e[a])&&(r=(n<3?s(r):n>3?s(t,i,r):s(t,i))||r);return n>3&&r&&Object.defineProperty(t,i,r),r;},v=this&&this.__param||function(e,t){return function(i,o){t(i,o,e);};};function O(e){return e.toString();}class E{constructor(e,t,i){this.model=e,this._modelEventListeners=new r.DisposableStore,this.model=e,this._modelEventListeners.add(e.onWillDispose(()=>t(e))),this._modelEventListeners.add(e.onDidChangeLanguage(t=>i(e,t)));}dispose(){this._modelEventListeners.dispose();}}let R=a.isLinux||a.isMacintosh?1:2;class C{constructor(e,t,i,o,s,n,r,a){this.uri=e,this.initialUndoRedoSnapshot=t,this.time=i,this.sharesUndoRedoStack=o,this.heapSize=s,this.sha1=n,this.versionId=r,this.alternativeVersionId=a;}}let b=class extends r.Disposable{static #e=o=this;static #t=this.MAX_MEMORY_FOR_CLOSED_FILES_UNDO_STACK=20971520;constructor(e,t,i,o){super(),this._configurationService=e,this._resourcePropertiesService=t,this._undoRedoService=i,this._instantiationService=o,this._onModelAdded=this._register(new n.Emitter),this.onModelAdded=this._onModelAdded.event,this._onModelRemoved=this._register(new n.Emitter),this.onModelRemoved=this._onModelRemoved.event,this._onModelModeChanged=this._register(new n.Emitter),this.onModelLanguageChanged=this._onModelModeChanged.event,this._modelCreationOptionsByLanguageAndResource=Object.create(null),this._models={},this._disposedModels=new Map,this._disposedModelsHeapSize=0,this._register(this._configurationService.onDidChangeConfiguration(e=>this._updateModelOptions(e))),this._updateModelOptions(void 0);}static _readModelOptions(e,t){var i;let o=l.EDITOR_MODEL_DEFAULTS.tabSize;if(e.editor&&void 0!==e.editor.tabSize){let t=parseInt(e.editor.tabSize,10);isNaN(t)||(o=t),o<1&&(o=1);}let s="tabSize";if(e.editor&&void 0!==e.editor.indentSize&&"tabSize"!==e.editor.indentSize){let t=parseInt(e.editor.indentSize,10);isNaN(t)||(s=Math.max(t,1));}let n=l.EDITOR_MODEL_DEFAULTS.insertSpaces;e.editor&&void 0!==e.editor.insertSpaces&&(n="false"!==e.editor.insertSpaces&&!!e.editor.insertSpaces);let r=R,a=e.eol;"\r\n"===a?r=2:"\n"===a&&(r=1);let d=l.EDITOR_MODEL_DEFAULTS.trimAutoWhitespace;e.editor&&void 0!==e.editor.trimAutoWhitespace&&(d="false"!==e.editor.trimAutoWhitespace&&!!e.editor.trimAutoWhitespace);let c=l.EDITOR_MODEL_DEFAULTS.detectIndentation;e.editor&&void 0!==e.editor.detectIndentation&&(c="false"!==e.editor.detectIndentation&&!!e.editor.detectIndentation);let u=l.EDITOR_MODEL_DEFAULTS.largeFileOptimizations;e.editor&&void 0!==e.editor.largeFileOptimizations&&(u="false"!==e.editor.largeFileOptimizations&&!!e.editor.largeFileOptimizations);let h=l.EDITOR_MODEL_DEFAULTS.bracketPairColorizationOptions;return(null===(i=e.editor)||void 0===i?void 0:i.bracketPairColorization)&&"object"==typeof e.editor.bracketPairColorization&&(h={enabled:!!e.editor.bracketPairColorization.enabled,independentColorPoolPerBracketType:!!e.editor.bracketPairColorization.independentColorPoolPerBracketType}),{isForSimpleWidget:t,tabSize:o,indentSize:s,insertSpaces:n,detectIndentation:c,defaultEOL:r,trimAutoWhitespace:d,largeFileOptimizations:u,bracketPairColorizationOptions:h};}_getEOL(e,t){if(e)return this._resourcePropertiesService.getEOL(e,t);let i=this._configurationService.getValue("files.eol",{overrideIdentifier:t});return i&&"string"==typeof i&&"auto"!==i?i:3===a.OS||2===a.OS?"\n":"\r\n";}_shouldRestoreUndoStack(){let e=this._configurationService.getValue("files.restoreUndoStack");return"boolean"!=typeof e||e;}getCreationOptions(e,t,i){let s="string"==typeof e?e:e.languageId,n=this._modelCreationOptionsByLanguageAndResource[s+t];if(!n){let e=this._configurationService.getValue("editor",{overrideIdentifier:s,resource:t}),r=this._getEOL(t,s);n=o._readModelOptions({editor:e,eol:r},i),this._modelCreationOptionsByLanguageAndResource[s+t]=n;}return n;}_updateModelOptions(e){let t=this._modelCreationOptionsByLanguageAndResource;this._modelCreationOptionsByLanguageAndResource=Object.create(null);let i=Object.keys(this._models);for(let s=0,n=i.length;s<n;s++){let n=i[s],r=this._models[n],a=r.model.getLanguageId(),d=r.model.uri;if(e&&!e.affectsConfiguration("editor",{overrideIdentifier:a,resource:d})&&!e.affectsConfiguration("files.eol",{overrideIdentifier:a,resource:d}))continue;let l=t[a+d],c=this.getCreationOptions(a,d,r.model.isForSimpleWidget);o._setModelOptionsForModel(r.model,c,l);}}static _setModelOptionsForModel(e,t,i){i&&i.defaultEOL!==t.defaultEOL&&1===e.getLineCount()&&e.setEOL(1===t.defaultEOL?0:1),i&&i.detectIndentation===t.detectIndentation&&i.insertSpaces===t.insertSpaces&&i.tabSize===t.tabSize&&i.indentSize===t.indentSize&&i.trimAutoWhitespace===t.trimAutoWhitespace&&(0,m.equals)(i.bracketPairColorizationOptions,t.bracketPairColorizationOptions)||(t.detectIndentation?(e.detectIndentation(t.insertSpaces,t.tabSize),e.updateOptions({trimAutoWhitespace:t.trimAutoWhitespace,bracketColorizationOptions:t.bracketPairColorizationOptions})):e.updateOptions({insertSpaces:t.insertSpaces,tabSize:t.tabSize,indentSize:t.indentSize,trimAutoWhitespace:t.trimAutoWhitespace,bracketColorizationOptions:t.bracketPairColorizationOptions}));}_insertDisposedModel(e){this._disposedModels.set(O(e.uri),e),this._disposedModelsHeapSize+=e.heapSize;}_removeDisposedModel(e){let t=this._disposedModels.get(O(e));return t&&(this._disposedModelsHeapSize-=t.heapSize),this._disposedModels.delete(O(e)),t;}_ensureDisposedModelsHeapSize(e){if(this._disposedModelsHeapSize>e){let t=[];for(this._disposedModels.forEach(e=>{e.sharesUndoRedoStack||t.push(e);}),t.sort((e,t)=>e.time-t.time);t.length>0&&this._disposedModelsHeapSize>e;){let e=t.shift();this._removeDisposedModel(e.uri),null!==e.initialUndoRedoSnapshot&&this._undoRedoService.restoreSnapshot(e.initialUndoRedoSnapshot);}}}_createModelData(e,t,i,o){let s=this.getCreationOptions(t,i,o),n=this._instantiationService.createInstance(d.TextModel,e,t,s,i);if(i&&this._disposedModels.has(O(i))){let e=this._removeDisposedModel(i),t=this._undoRedoService.getElements(i),o=this._getSHA1Computer(),s=!!o.canComputeSHA1(n)&&o.computeSHA1(n)===e.sha1;if(s||e.sharesUndoRedoStack){for(let e of t.past)(0,S.isEditStackElement)(e)&&e.matchesResource(i)&&e.setModel(n);for(let e of t.future)(0,S.isEditStackElement)(e)&&e.matchesResource(i)&&e.setModel(n);this._undoRedoService.setElementsValidFlag(i,!0,e=>(0,S.isEditStackElement)(e)&&e.matchesResource(i)),s&&(n._overwriteVersionId(e.versionId),n._overwriteAlternativeVersionId(e.alternativeVersionId),n._overwriteInitialUndoRedoSnapshot(e.initialUndoRedoSnapshot));}else null!==e.initialUndoRedoSnapshot&&this._undoRedoService.restoreSnapshot(e.initialUndoRedoSnapshot);}let r=O(n.uri);if(this._models[r])throw Error("ModelService: Cannot add model because it already exists!");let a=new E(n,e=>this._onWillDispose(e),(e,t)=>this._onDidChangeLanguage(e,t));return this._models[r]=a,a;}createModel(e,t,i,o=!1){let s;return s=t?this._createModelData(e,t,i,o):this._createModelData(e,c.PLAINTEXT_LANGUAGE_ID,i,o),this._onModelAdded.fire(s.model),s.model;}getModels(){let e=[],t=Object.keys(this._models);for(let i=0,o=t.length;i<o;i++){let o=t[i];e.push(this._models[o].model);}return e;}getModel(e){let t=O(e),i=this._models[t];return i?i.model:null;}_schemaShouldMaintainUndoRedoElements(e){return e.scheme===g.Schemas.file||e.scheme===g.Schemas.vscodeRemote||e.scheme===g.Schemas.vscodeUserData||e.scheme===g.Schemas.vscodeNotebookCell||"fake-fs"===e.scheme;}_onWillDispose(e){let t=O(e.uri),i=this._models[t],s=this._undoRedoService.getUriComparisonKey(e.uri)!==e.uri.toString(),n=!1,r=0;if(s||this._shouldRestoreUndoStack()&&this._schemaShouldMaintainUndoRedoElements(e.uri)){let t=this._undoRedoService.getElements(e.uri);if(t.past.length>0||t.future.length>0){for(let i of t.past)(0,S.isEditStackElement)(i)&&i.matchesResource(e.uri)&&(n=!0,r+=i.heapSize(e.uri),i.setModel(e.uri));for(let i of t.future)(0,S.isEditStackElement)(i)&&i.matchesResource(e.uri)&&(n=!0,r+=i.heapSize(e.uri),i.setModel(e.uri));}}let a=o.MAX_MEMORY_FOR_CLOSED_FILES_UNDO_STACK,d=this._getSHA1Computer();if(n){if(s||!(r>a)&&d.canComputeSHA1(e))this._ensureDisposedModelsHeapSize(a-r),this._undoRedoService.setElementsValidFlag(e.uri,!1,t=>(0,S.isEditStackElement)(t)&&t.matchesResource(e.uri)),this._insertDisposedModel(new C(e.uri,i.model.getInitialUndoRedoSnapshot(),Date.now(),s,r,d.computeSHA1(e),e.getVersionId(),e.getAlternativeVersionId()));else{let e=i.model.getInitialUndoRedoSnapshot();null!==e&&this._undoRedoService.restoreSnapshot(e);}}else if(!s){let e=i.model.getInitialUndoRedoSnapshot();null!==e&&this._undoRedoService.restoreSnapshot(e);}delete this._models[t],i.dispose(),delete this._modelCreationOptionsByLanguageAndResource[e.getLanguageId()+e.uri],this._onModelRemoved.fire(e);}_onDidChangeLanguage(e,t){let i=t.oldLanguage,s=e.getLanguageId(),n=this.getCreationOptions(i,e.uri,e.isForSimpleWidget),r=this.getCreationOptions(s,e.uri,e.isForSimpleWidget);o._setModelOptionsForModel(e,r,n),this._onModelModeChanged.fire({model:e,oldLanguageId:i});}_getSHA1Computer(){return new I;}};b=o=M([v(0,h.IConfigurationService),v(1,u.ITextResourcePropertiesService),v(2,p.IUndoRedoService),v(3,f.IInstantiationService)],b);class I{static #e=this.MAX_MODEL_SIZE=10485760;canComputeSHA1(e){return e.getValueLength()<=I.MAX_MODEL_SIZE;}computeSHA1(e){let t;let i=new _.StringSHA1,o=e.createSnapshot();for(;t=o.read();)i.update(t);return i.digest();}}},"590b2780":function(e,t,i){"use strict";i.d(t,"__esModule",{value:!0}),i.d(t,"ITreeSitterParserService",{enumerable:!0,get:function(){return o;}});let o=(0,i("2aa5bed3").createDecorator)("treeSitterParserService");},eaa7c5e8:function(e,t,i){"use strict";i.d(t,"__esModule",{value:!0}),i.e(t,{ITextResourceConfigurationService:function(){return s;},ITextResourcePropertiesService:function(){return n;}});var o=i("2aa5bed3");let s=(0,o.createDecorator)("textResourceConfigurationService"),n=(0,o.createDecorator)("textResourcePropertiesService");}}]);
